# NHL Game Outcome Prediction Model - README

**Group Number:** 1
**Python Version Required:** 3.9+
**Date:** November 2024

---

## Table of Contents

1. [Project Overview](#project-overview)
2. [Files in This Package](#files-in-this-package)
3. [System Requirements](#system-requirements)
4. [Installation Instructions](#installation-instructions)
5. [Data Preparation](#data-preparation)
6. [Running the Analysis](#running-the-analysis)
7. [Expected Outputs](#expected-outputs)
8. [Model Description](#model-description)
9. [Expected Runtime](#expected-runtime)
10. [Known Issues & Limitations](#known-issues--limitations)
11. [Troubleshooting](#troubleshooting)

---

## Project Overview

This replication package contains code for building and evaluating predictive models for NHL regular season game outcomes at the end of regulation time (60 minutes). The models predict probabilities for three possible outcomes:

- **0:** Away team win
- **1:** Tie
- **2:** Home team win

The project follows strict chronological data splits to avoid data leakage:
- **Training/Validation:** 2011-2020 (for model development and hyperparameter tuning)
- **Test Set:** 2021-2023 (FROZEN - used only for final evaluation)

---

## Files in This Package

### Core Files

| File | Description |
|------|-------------|
| `prepare_data.py` | Data preparation script that combines `gamedata.csv` and `playergamedata.csv` |
| `se_assignment1_1_code.py` | Main prediction model script (CORE DELIVERABLE) |
| `se_assignment1_1_data.csv` | Prepared dataset (generated by `prepare_data.py`) |
| `requirements.txt` | Python package dependencies with versions |
| `README.md` | This file (convert to PDF for submission) |

### Input Data Files (Required - Not Included)

| File | Description | Source |
|------|-------------|--------|
| `gamedata.csv` | Game-level data with odds and outcomes | Assignment materials |
| `playergamedata.csv` | Player-level game statistics | Assignment materials |

### Output Files (Generated by Analysis)

| File | Description |
|------|-------------|
| `test_predictions.csv` | Model predictions on 2021-2023 test set |
| `test_metrics.json` | Performance metrics (Brier score, accuracy, etc.) |
| `model_comparison.csv` | Validation performance of all models |
| `betting_history.csv` | Record of all bets placed in simulation |
| `feature_importances.png` | Feature importance plot |
| `calibration_curves.png` | Probability calibration plots |
| `betting_cumulative_profit.png` | Betting profit over time |
| `model_comparison.png` | Model performance comparison chart |

---

## System Requirements

### Operating System
- Windows 10/11
- macOS 10.15+
- Linux (Ubuntu 20.04+ or equivalent)

### Software
- **Python:** 3.9, 3.10, or 3.11 (3.12 not tested)
- **pip:** Latest version
- **RAM:** Minimum 4GB, recommended 8GB+
- **Disk Space:** At least 2GB free

---

## Installation Instructions

### Step 1: Install Python

Ensure Python 3.9 or higher is installed:

```bash
python --version
```

If not installed, download from [python.org](https://www.python.org/downloads/)

### Step 2: Create Virtual Environment (Recommended)

```bash
# Windows
python -m venv nhl_env
nhl_env\Scripts\activate

# macOS/Linux
python3 -m venv nhl_env
source nhl_env/bin/activate
```

### Step 3: Install Required Packages

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

This will install:
- pandas 2.1.0
- numpy 1.24.3
- scikit-learn 1.3.0
- xgboost 2.0.0
- lightgbm 4.0.0
- matplotlib 3.7.2
- seaborn 0.12.2
- statsmodels 0.14.0

**Note:** Installation may take 5-10 minutes depending on your internet connection.

---

## Data Preparation

### Step 1: Obtain Source Data

Place the following files in the same directory as the scripts:

- `gamedata.csv` (from assignment materials)
- `playergamedata.csv` (from assignment materials)

### Step 2: Run Data Preparation Script

```bash
python prepare_data.py
```

**Expected output:**
```
============================================================
NHL Data Preparation
============================================================

[1/4] Loading raw data files...
  Loaded gamedata.csv: X,XXX rows
  Loaded playergamedata.csv: XXX,XXX rows

[2/4] Preparing game-level data...
  Games with missing odds: XX
  Games after removing missing odds: X,XXX

  Result distribution:
    Away wins (0): X,XXX
    Ties (1): X,XXX
    Home wins (2): X,XXX

[3/4] Aggregating player statistics...
  Combined dataset: X,XXX games

[4/4] Saving processed data...
  Saved to: se_assignment1_1_data.csv

============================================================
Data preparation complete!
============================================================
```

This creates `se_assignment1_1_data.csv`, which is required for the main analysis.

---

## Running the Analysis

### Execute Main Script

```bash
python se_assignment1_1_code.py
```

### What the Script Does

The script performs the following steps:

1. **Load Data:** Loads prepared dataset
2. **Feature Engineering:** Creates ELO ratings, rolling statistics, and other features
3. **Data Splitting:** Splits into training (2011-2020) and test (2021-2023) sets
4. **Benchmark Calculation:** Evaluates bookmaker odds as baseline
5. **Model Training:** Trains 4 models on validation set:
   - Multinomial Logistic Regression
   - Random Forest
   - XGBoost
   - LightGBM
6. **Model Selection:** Selects best model based on validation Brier score
7. **Final Training:** Retrains selected model on full training set (2011-2020)
8. **Test Evaluation:** Evaluates on frozen test set (2021-2023)
9. **Betting Simulation:** Simulates betting strategy on test set
10. **Visualization:** Generates plots and saves results

### Progress Output

The script provides detailed progress output:

```
================================================================================
NHL GAME OUTCOME PREDICTION MODEL
================================================================================
Training Period: 2011-01-01 to 2020-12-31
Test Period: 2021-01-01 to 2023-12-31
Random Seed: 42
================================================================================

[1/10] Loading data...
[2/10] Engineering features...
[3/10] Preparing features for modeling...
[4/10] Calculating bookmaker benchmark...
[5/10] Training Model 1: Multinomial Logistic Regression...
[6/10] Training Model 2: Random Forest...
[7/10] Training Model 3: XGBoost...
[8/10] Training Model 4: LightGBM...
[9/10] Retraining [best model] on full training set...
[10/10] Evaluating on TEST SET (2021-2023)...
```

---

## Expected Outputs

### Console Output

The final output will display:

```
================================================================================
FINAL TEST SET RESULTS (2021-2023)
================================================================================
Model: [Selected Model Name]

Brier Score:  X.XXXX
Accuracy:     X.XXXX (XX.XX%)
Log Loss:     X.XXXX

Comparison to Bookmaker:
  Bookmaker Brier: X.XXXX
  Our Brier:       X.XXXX
  Improvement:     X.XXXX
================================================================================

Confusion Matrix:
                  Predicted
              Away    Tie    Home
Actual Away   XXXX   XXXX   XXXX
       Tie    XXXX   XXXX   XXXX
       Home   XXXX   XXXX   XXXX

================================================================================
BETTING SIMULATION (2021-2023)
================================================================================

Betting Strategy: Positive Expected Value
  - Bet when our probability exceeds bookmaker by >3%
  - Flat stake: $10 per bet
  - Test period: 2021-2023

RESULTS:
  Total Profit/Loss: $XXX.XX
  Number of Bets:    XXX
  Number of Wins:    XXX
  Win Rate:          XX.XX%
  ROI:               XX.XX%
  Sharpe Ratio:      X.XXXX
  Max Drawdown:      $XXX.XX
================================================================================
```

### Generated Files

All output files are saved in the current directory. See [Files in This Package](#files-in-this-package) section for details.

---

## Model Description

### Features

The models use the following feature categories:

1. **ELO Ratings** (3 features)
   - Home team ELO rating (before game)
   - Away team ELO rating (before game)
   - ELO difference (home - away)

2. **Rolling Goal Statistics** (18 features)
   - Goals for/against over last 5, 10, 20 games
   - Goal differential over last 5, 10, 20 games
   - Calculated separately for home and away teams

3. **Rest Days** (3 features)
   - Days since last game (home team)
   - Days since last game (away team)
   - Rest day differential

4. **Home Advantage** (1 feature)
   - Binary indicator for home team

**Total:** 25 features

### Feature Engineering Details

**ELO Ratings:**
- Initial rating: 1500 for all teams
- K-factor: 20 (controls learning rate)
- Home advantage: 100 ELO points
- Updated after each game using standard ELO formula
- **No leakage:** Uses ratings BEFORE each game

**Rolling Statistics:**
- Windows: 5, 10, and 20 games
- **No leakage:** Uses `.shift(1)` to exclude current game
- Missing values (early season) filled with training set mean

**Rest Days:**
- Calculated as days between consecutive games
- Default: 5 days for first game of season

### Models Compared

1. **Multinomial Logistic Regression**
   - Multi-class classification with softmax
   - L2 regularization (C=1.0)
   - Features standardized

2. **Random Forest**
   - 200 trees
   - Max depth: 15
   - Min samples split: 20
   - Handles non-linear relationships

3. **XGBoost**
   - 200 boosting rounds
   - Max depth: 6
   - Learning rate: 0.05
   - Subsample: 0.8
   - Gradient boosting with regularization

4. **LightGBM**
   - 200 boosting rounds
   - Max depth: 6
   - Learning rate: 0.05
   - Faster alternative to XGBoost

### Model Selection

- Models trained on 2011-2018 data
- Validated on 2019-2020 data
- Best model selected based on **lowest validation Brier score**
- Final model retrained on full 2011-2020 period
- **Model frozen** before test set evaluation

### Betting Strategy

**Strategy:** Positive Expected Value (EV)

- Calculate edge: Our probability - Bookmaker probability
- Place bet if edge > 3% threshold
- Bet on outcome with largest positive edge
- Flat stake: $10 per bet
- Simulated only on test set (2021-2023)

---

## Expected Runtime

Approximate execution times (varies by hardware):

| Step | Time | CPU |
|------|------|-----|
| Data preparation | 30-60 seconds | Any |
| Feature engineering | 2-3 minutes | Any |
| Model training | 3-5 minutes | Multi-core recommended |
| Total runtime | **5-10 minutes** | 4+ cores |

**Hardware tested:**
- Intel i7 / AMD Ryzen 5 or better
- 8GB RAM
- SSD storage

---

## Known Issues & Limitations

### Data Limitations

1. **Missing Player Data:** Not all games have complete player statistics
   - Solution: Use team-level aggregates where available
   - Impact: Minimal, most games have complete data

2. **Early Season Games:** First 5-20 games of each season lack rolling statistics
   - Solution: Fill with training set mean
   - Impact: Minor, affects <5% of games

3. **Team Relocations/Name Changes:** Not explicitly handled
   - Example: Atlanta Thrashers → Winnipeg Jets (2011)
   - Impact: ELO ratings reset for "new" teams

### Model Limitations

1. **Tie Prediction:** Ties are rare (~10% of games) and hard to predict
   - Models may underpredict ties
   - Consider this when using for betting

2. **Regime Changes:** Model assumes stable game dynamics over 2011-2023
   - NHL rule changes not explicitly modeled
   - COVID-shortened seasons (2020-21) may affect results

3. **Feature Leakage Check:** While extensive checks performed, always verify
   - All features use `.shift(1)` or pre-game information only
   - ELO ratings calculated sequentially

### Technical Limitations

1. **Random Seed:** Results may vary slightly across different:
   - Operating systems
   - NumPy/scikit-learn versions
   - Solution: Use exact package versions in requirements.txt

2. **Memory Usage:** Large datasets (>100k games) may require >8GB RAM

---

## Troubleshooting

### Problem: ModuleNotFoundError

**Error:** `ModuleNotFoundError: No module named 'xgboost'`

**Solution:**
```bash
pip install -r requirements.txt
```

Ensure virtual environment is activated.

---

### Problem: File Not Found Error

**Error:** `FileNotFoundError: se_assignment1_1_data.csv`

**Solution:**
1. Ensure `gamedata.csv` and `playergamedata.csv` are in current directory
2. Run `python prepare_data.py` first
3. Then run `python se_assignment1_1_code.py`

---

### Problem: Results Don't Match Exactly

**Cause:** Different package versions or OS

**Solution:**
1. Check Python version: `python --version` (should be 3.9-3.11)
2. Check package versions: `pip list`
3. Reinstall exact versions: `pip install -r requirements.txt --force-reinstall`

---

### Problem: Script Runs Very Slowly

**Cause:** Limited CPU cores or old hardware

**Solution:**
- Random Forest and XGBoost use parallel processing
- Reduce `n_jobs` parameter from `-1` to `2` in code
- Or reduce `n_estimators` from 200 to 100

---

### Problem: Visualizations Not Generated

**Cause:** Missing display backend (on remote servers)

**Solution:**
Add to top of script:
```python
import matplotlib
matplotlib.use('Agg')  # Non-interactive backend
```

---

## Contact & Support

For questions about this replication package:

1. **Check console output** for specific error messages
2. **Verify all input files** are present and correctly formatted
3. **Check Python and package versions** match requirements

---

## Reproduction Checklist

Use this checklist to verify successful reproduction:

- [ ] Python 3.9+ installed
- [ ] Virtual environment created and activated
- [ ] All packages installed from requirements.txt
- [ ] `gamedata.csv` and `playergamedata.csv` in current directory
- [ ] `prepare_data.py` runs without errors
- [ ] `se_assignment1_1_data.csv` generated
- [ ] `se_assignment1_1_code.py` runs to completion
- [ ] All output files generated:
  - [ ] test_predictions.csv
  - [ ] test_metrics.json
  - [ ] model_comparison.csv
  - [ ] betting_history.csv
  - [ ] 4 PNG visualization files
- [ ] Test set Brier score and accuracy match reported values
- [ ] Betting simulation results match reported values

---

## License & Attribution

This code was developed for the Sport Economics Assignment 1 (November 2024).

**Data Source:** NHL game data and odds from assignment materials

**References:**
- Holmes, B., & McHale, I. G. (2024). Forecasting football match results using a player rating based model. *International Journal of Forecasting, 40*(1), 302–312.

---

**End of README**

*For PDF conversion: Use pandoc or any Markdown-to-PDF converter*

```bash
# Example conversion command:
pandoc README.md -o se_assignment1_1_README.pdf --pdf-engine=xelatex
```
